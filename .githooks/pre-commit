#!/usr/bin/env bash
set -euo pipefail

# Collect staged .dart files (null-delimited) using process substitution to preserve NULs
mapfile -d '' -t STAGED < <(git diff --name-only --cached --diff-filter=ACM -z)
DART_TARGETS=()
for f in "${STAGED[@]}"; do
  case "$f" in
    *.dart) DART_TARGETS+=("$f") ;;
    *) ;;
  esac
done

if [ ${#DART_TARGETS[@]} -eq 0 ]; then
  exit 0
fi

echo "pre-commit: formatting Dart files..."
if command -v dart >/dev/null 2>&1; then
  dart format -l 100 -- "${DART_TARGETS[@]}"
elif command -v flutter >/dev/null 2>&1; then
  # fallback if dart shim isn't on PATH
  flutter format -l 100 -- "${DART_TARGETS[@]}"
else
  echo "pre-commit: dart/flutter not found. Install Flutter SDK so 'dart' or 'flutter' is on PATH." >&2
  exit 1
fi
git add -- "${DART_TARGETS[@]}"

exit 0
